import os
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    CallbackQueryHandler,
    MessageHandler,
    ContextTypes,
    filters
)

TOKEN = os.getenv("BOT_TOKEN")
GROUP_ID = os.getenv("GROUP_ID")  # Ø§ÛŒÙ†Ùˆ Ø¨Ø¹Ø¯Ø§Ù‹ ØªÙˆ Render ÙˆØ§Ø±Ø¯ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…

# ---- Ø¯Ø³ØªÙˆØ± Ø¨Ø±Ø§ÛŒ Ú¯Ø±ÙØªÙ† Ø¢ÛŒØ¯ÛŒ Ú¯Ø±ÙˆÙ‡ ----
async def get_group_id(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    await update.message.reply_text(f"Ø¢ÛŒØ¯ÛŒ Ø§ÛŒÙ† Ú¯Ø±ÙˆÙ‡: {chat_id}")

# ---- Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª ----
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data.clear()
    await update.message.reply_text(
        "Ø³Ù„Ø§Ù… ğŸŒ±\nØ§Ø³Ù…Øª Ú†ÛŒÙ‡ØŸ\n(Ø¨Ø±Ø§ÛŒ Ú¯Ø±ÙØªÙ† Ø¢ÛŒØ¯ÛŒ Ú¯Ø±ÙˆÙ‡ /getid Ø±Ùˆ Ù‡Ù… Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒ)"
    )

# ---- Ú¯Ø±ÙØªÙ† Ø§Ø³Ù… ----
async def get_name(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data["name"] = update.message.text

    keyboard = [
        [
            InlineKeyboardButton("ğŸ® Ø¨Ø§Ø²ÛŒ", callback_data="interest_game"),
            InlineKeyboardButton("ğŸ“š Ù…Ø·Ø§Ù„Ø¹Ù‡", callback_data="interest_book")
        ],
        [
            InlineKeyboardButton("ğŸ¨ Ù‡Ù†Ø±", callback_data="interest_art")
        ]
    ]

    await update.message.reply_text(
        "Ø¨Ù‡ Ú†ÛŒ Ø¹Ù„Ø§Ù‚Ù‡ Ø¯Ø§Ø±ÛŒØŸ",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

# ---- Ú¯Ø±ÙØªÙ† Ø¹Ù„Ø§Ù‚Ù‡ ----
async def get_interest(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    context.user_data["interest"] = query.data.replace("interest_", "")

    keyboard = [
        [
            InlineKeyboardButton("ğŸŸ¢ Ù…Ø¨ØªØ¯ÛŒ", callback_data="level_beginner"),
            InlineKeyboardButton("ğŸ”µ Ù…ØªÙˆØ³Ø·", callback_data="level_mid"),
            InlineKeyboardButton("ğŸ”´ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ", callback_data="level_pro")
        ]
    ]

    await query.message.reply_text(
        "Ø³Ø·Ø­Øª Ú†ÛŒÙ‡ØŸ",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

# ---- Ú¯Ø±ÙØªÙ† Ø³Ø·Ø­ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ ----
async def get_level(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    context.user_data["level"] = query.data.replace("level_", "")

    data = context.user_data

    text = (
        "ğŸ“¥ ÙØ±Ù… Ø¬Ø¯ÛŒØ¯:\n\n"
        f"ğŸ‘¤ Ø§Ø³Ù…: {data['name']}\n"
        f"â­ Ø¹Ù„Ø§Ù‚Ù‡: {data['interest']}\n"
        f"ğŸ“Š Ø³Ø·Ø­: {data['level']}"
    )

    # Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡
    await context.bot.send_message(chat_id=int(GROUP_ID), text=text)
    await query.message.reply_text("âœ… Ø«Ø¨Øª Ø´Ø¯! Ù…Ù…Ù†ÙˆÙ† ğŸŒ±")

# ---- ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ ----
def main():
    app = ApplicationBuilder().token(TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("getid", get_group_id))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, get_name))
    app.add_handler(CallbackQueryHandler(get_interest, pattern="^interest_"))
    app.add_handler(CallbackQueryHandler(get_level, pattern="^level_"))

    print("Bot started...")
    app.run_polling()

if __name__ == "__main__":
    main()
